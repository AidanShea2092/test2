<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMC HELP DESK // FRONTIER</title>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        :root {
            --c-bg: #181A1D;
            --c-surface: #22262B;
            --c-border: #4F5864;
            --c-text-primary: #E0E6F0;
            --c-text-secondary: #8A98A7;
            --c-accent-orange: #D95525;
            --c-accent-orange-hover: #F76B39;
            --c-accent-red: #E63525;
            --c-accent-blue: #30B4E6;
            --c-accent-gray: #444;
            --c-accent-gray-text: #888;
            --font-family: 'Share Tech Mono', monospace;
            --border-radius: 0;
            --shadow-glow: 0 0 8px rgba(217, 85, 37, 0.5);
        }

        body {
            font-family: var(--font-family);
            margin: 0; padding: 0;
            background-color: var(--c-bg);
            color: var(--c-text-primary);
            display: flex; flex-direction: column;
            min-height: 100vh; font-size: 16px;
            background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 3px 3px;
        }

        h1, h2, h3 { color: var(--c-accent-orange); font-weight: 400; text-shadow: var(--shadow-glow); text-transform: uppercase; }
        h3 { border-bottom: 1px solid var(--c-border); padding-bottom: 10px; }
        hr { border: none; border-top: 1px dashed var(--c-border); margin: 30px 0; }

        nav {
            background-color: var(--c-surface); padding: 0 20px; display: flex; gap: 10px;
            border-bottom: 1px solid var(--c-accent-orange); box-shadow: var(--shadow-glow); flex-wrap: wrap;
        }
        nav button {
            background: none; color: var(--c-text-secondary); border: none;
            border-bottom: 3px solid transparent; padding: 15px 20px;
            font-size: 16px; font-weight: 400; cursor: pointer;
            transition: all 0.2s ease; margin-bottom: -1px; text-transform: uppercase; font-family: var(--font-family);
        }
        nav button:hover { color: var(--c-accent-orange-hover); background: rgba(217, 85, 37, 0.1); }
        nav button.active { color: var(--c-accent-orange); border-bottom-color: var(--c-accent-orange); background: none; }

        main { flex-grow: 1; padding: 20px; }
        .page { display: none; }
        .page.active { display: block; }
        #page-new-ticket h2, #page-view-tickets h2, #page-loaners h2 { text-align: center; font-size: 2em; }

        .form-grid {
            display: grid; grid-template-columns: 1fr; gap: 20px; max-width: 700px;
            margin: 0 auto; background: var(--c-surface); padding: 25px;
            border: 1px solid var(--c-border); border-radius: var(--border-radius);
        }
        @media (min-width: 600px) { .form-grid { grid-template-columns: 1fr 1fr; } .form-field-full { grid-column: 1 / -1; } }

        .form-field { display: flex; flex-direction: column; }
        .form-field label { margin-bottom: 8px; font-size: 0.9em; color: var(--c-text-secondary); text-transform: uppercase; }
        .required-asterisk { color: var(--c-accent-red); margin-left: 3px; }

        .form-field input, .form-field select, .form-field textarea {
            padding: 12px; font-size: 16px; border: 1px solid var(--c-border);
            border-radius: var(--border-radius); width: 100%; box-sizing: border-box;
            background-color: var(--c-bg); color: var(--c-text-primary);
            font-family: var(--font-family); transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-field input:focus, .form-field select:focus, .form-field textarea:focus {
            outline: none; border-color: var(--c-accent-orange); box-shadow: var(--shadow-glow); background-color: var(--c-surface);
        }
        .form-field textarea { min-height: 120px; resize: vertical; }

        button.submit-btn {
            background-color: var(--c-accent-orange); color: var(--c-bg);
            padding: 14px 20px; border: none; border-radius: var(--border-radius);
            cursor: pointer; font-size: 16px; width: 100%; text-transform: uppercase;
            font-family: var(--font-family); transition: background-color 0.2s; grid-column: 1 / -1;
        }
        button.submit-btn:hover { background-color: var(--c-accent-orange-hover); }
        button.submit-btn:disabled { background-color: var(--c-accent-gray); cursor: not-allowed; }

        /* Tickets List */
        #active-tickets-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .ticket-card {
            background: var(--c-surface); border: 1px solid var(--c-border);
            border-left: 5px solid var(--c-accent-orange); padding: 15px 20px;
            transition: all 0.2s;
        }
        .ticket-card:hover { transform: translateY(-2px); border-color: var(--c-accent-orange); box-shadow: var(--shadow-glow); }
        .ticket-card p { margin: 8px 0; color: var(--c-text-secondary); }
        .ticket-card strong { color: var(--c-text-primary); }
        .ticket-card .actions { margin-top: 15px; display: flex; gap: 10px; }
        .ticket-card button {
            padding: 8px 12px; border: 1px solid; border-radius: var(--border-radius);
            cursor: pointer; background: transparent; text-transform: uppercase;
            font-family: var(--font-family); font-size: 14px;
        }
        .btn-view { color: var(--c-accent-blue); border-color: var(--c-accent-blue); }
        .btn-view:hover { background: var(--c-accent-blue); color: var(--c-bg); }
        .btn-close-ticket { color: var(--c-accent-red); border-color: var(--c-accent-red); }
        .btn-close-ticket:hover { background: var(--c-accent-red); color: var(--c-text-primary); }

        /* Tables */
        .search-container { max-width: 800px; margin: 0 auto 15px auto; }
        .search-container input { width: 100%; padding: 12px; font-size: 16px; border: 1px solid var(--c-border); background: var(--c-surface); color: var(--c-text-primary); font-family: var(--font-family); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: var(--c-surface); border: 1px solid var(--c-border); }
        #page-loaners table { max-width: 800px; margin: 0 auto; }
        th, td { border: 1px solid var(--c-border); padding: 14px; text-align: left; }
        th { background-color: #111; color: var(--c-accent-orange); text-transform: uppercase; }
        tr:nth-child(even) { background-color: var(--c-bg); }
        .btn-check-in { background: transparent; color: var(--c-accent-blue); border: 1px solid var(--c-accent-blue); padding: 8px 12px; cursor: pointer; text-transform: uppercase; font-family: var(--font-family); }
        .btn-check-in:hover { background: var(--c-accent-blue); color: var(--c-bg); }

        /* Reports */
        .report-stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-card { background: var(--c-surface); padding: 20px; border: 1px solid var(--c-border); flex-grow: 1; text-align: center; }
        .stat-number { font-size: 3em; color: var(--c-accent-orange); text-shadow: var(--shadow-glow); }
        .occurrence-link { color: var(--c-accent-blue); cursor: pointer; border-bottom: 1px solid var(--c-accent-blue); }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(24, 26, 29, 0.9); backdrop-filter: blur(3px); }
        .modal-content { background-color: var(--c-surface); color: var(--c-text-primary); margin: 5% auto; padding: 25px; border: 1px solid var(--c-accent-orange); width: 80%; max-width: 600px; position: relative; box-shadow: var(--shadow-glow); }
        .modal-close { color: var(--c-text-secondary); position: absolute; top: 15px; right: 25px; font-size: 32px; cursor: pointer; }
        .modal-close:hover { color: var(--c-accent-orange); }

        /* Status Bar */
        #status-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--c-accent-blue); color: #000; text-align: center; padding: 5px; font-size: 14px; display: none; }
        
        footer { text-align: center; padding: 20px; color: var(--c-text-secondary); margin-top: 20px; text-transform: uppercase; }
    </style>
</head>
<body>

    <nav>
        <button id="nav-new-ticket" class="nav-btn active">New Issue Ticket</button>
        <button id="nav-view-tickets" class="nav-btn">View Active Tickets</button>
        <button id="nav-loaners" class="nav-btn">Loaners</button>
        <button id="nav-reports" class="nav-btn">Reports</button>
    </nav>

    <main>
        <div id="page-new-ticket" class="page active">
            <h2>New Issue Ticket</h2>
            <form id="form-new-ticket">
                <div class="form-grid">
                    <div class="form-field">
                        <label>First and Last Name<span class="required-asterisk">*</span></label>
                        <input type="text" id="ticket-name" required>
                    </div>
                    <div class="form-field">
                        <label>Today's Date<span class="required-asterisk">*</span></label>
                        <input type="text" id="ticket-date" readonly required>
                    </div>
                    <div class="form-field">
                        <label>Chromebook Barcode<span class="required-asterisk">*</span></label>
                        <input type="text" id="ticket-barcode" required>
                    </div>
                    <div class="form-field">
                        <label>Person's Email<span class="required-asterisk">*</span></label>
                        <input type="email" id="ticket-email" required>
                    </div>
                    <div class="form-field">
                        <label>Chromebook Type<span class="required-asterisk">*</span></label>
                        <select id="ticket-type" required>
                            <option value="">-- Select Type --</option>
                            <option value="HP">HP</option>
                            <option value="Lenovo">Lenovo</option>
                            <option value="Acer">Acer</option>
                            <option value="Dell">Dell</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label>Category of Problem<span class="required-asterisk">*</span></label>
                        <select id="ticket-category" required>
                            <option value="">-- Select Category --</option>
                            <option value="Keyboard">Keyboard</option>
                            <option value="Screen">Screen</option>
                            <option value="Battery">Battery</option>
                            <option value="Charging">Charging Port</option>
                            <option value="Trackpad">Trackpad</option>
                            <option value="Software">Software</option>
                            <option value="Physical Damage">Physical Damage</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-field form-field-full">
                        <label>Detailed Description<span class="required-asterisk">*</span></label>
                        <textarea id="ticket-description" placeholder="The 'D' key doesn't work, etc..." required></textarea>
                    </div>
                    <button type="submit" id="submit-ticket-btn" class="submit-btn" disabled>Submit Ticket</button>
                </div>
            </form>
        </div>

        <div id="page-view-tickets" class="page">
            <h2>Active Tickets</h2>
            <div id="active-tickets-list"></div>
        </div>

        <div id="page-loaners" class="page">
            <h2>Loaner Check Out</h2>
            <form id="form-loaner-checkout">
                <div class="form-grid">
                    <div class="form-field">
                        <label>Student Name<span class="required-asterisk">*</span></label>
                        <input type="text" id="loaner-name" required>
                    </div>
                    <div class="form-field">
                        <label>Loaner Barcode<span class="required-asterisk">*</span></label>
                        <input type="text" id="loaner-barcode" required>
                    </div>
                    <button type="submit" class="submit-btn">Check Out Loaner</button>
                </div>
            </form>
            <hr>
            <h2>Currently Checked Out Loaners</h2>
            <div class="search-container">
                <input type="text" id="loaner-search" placeholder="Search by Barcode...">
            </div>
            <table id="loaner-table">
                <thead><tr><th>Student Name</th><th>Loaner Barcode</th><th>Date Out</th><th>Action</th></tr></thead>
                <tbody id="loaner-table-body"></tbody>
            </table>
        </div>

        <div id="page-reports" class="page">
            <h2>Help Desk Reports</h2>
            <div class="report-stats">
                <div class="stat-card"><h3>Active Tickets</h3><div id="stat-active-tickets" class="stat-number">0</div></div>
                <div class="stat-card"><h3>Loaners Out</h3><div id="stat-loaners-out" class="stat-number">0</div></div>
            </div>
            <h3>Student Ticket Report</h3>
            <table id="report-table">
                <thead><tr><th>Name</th><th>Last Type</th><th>Last Issue</th><th>Count</th></tr></thead>
                <tbody id="report-table-body"></tbody>
            </table>
        </div>
    </main>

    <div id="details-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2 id="modal-title">Details</h2>
            <div id="modal-body"></div>
        </div>
    </div>

    <div id="status-bar">Syncing...</div>

    <footer>by the CCT I.T. Juniors 2025</footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // ===================================
        // PASTE YOUR GOOGLE WEB APP URL HERE
        // ===================================
        const ENDPOINT = "https://script.google.com/macros/s/AKfycbyXKAjy_CHVFWCV9DdfFCo6iuMghqRTYZ9y-1xdyVKzPOhnL53xdEoKda915DfTS5lB/exec"; 
        
        // State
        let allTickets = [];
        let allLoaners = [];

        // DOM
        const navButtons = document.querySelectorAll('.nav-btn');
        const pages = document.querySelectorAll('.page');
        const statusBar = document.getElementById('status-bar');
        
        // Forms
        const ticketForm = document.getElementById('form-new-ticket');
        const loanerForm = document.getElementById('form-loaner-checkout');
        const ticketNameEl = document.getElementById('ticket-name');
        const ticketEmailEl = document.getElementById('ticket-email');
        
        // --- 1. DATA SYNC FUNCTIONS ---

        function showStatus(msg) {
            statusBar.textContent = msg;
            statusBar.style.display = 'block';
            setTimeout(() => statusBar.style.display = 'none', 3000);
        }

        async function loadData() {
            showStatus("Loading data from Google Sheets...");
            try {
                if(ENDPOINT.includes("PASTE_YOUR")) {
                    console.warn("Endpoint not set.");
                    return;
                }
                const response = await fetch(ENDPOINT);
                const data = await response.json();
                allTickets = data.tickets || [];
                allLoaners = data.loaners || [];
                // Sort tickets by date (newest first)
                allTickets.sort((a, b) => new Date(b.date) - new Date(a.date));
                renderAllPages();
                showStatus("Data loaded.");
            } catch (err) {
                console.error(err);
                showStatus("Error loading data.");
            }
        }

        async function sendData(payload) {
            showStatus("Saving to Google Sheets...");
            try {
                // FIXED: Removed Headers causing CORS errors
                await fetch(ENDPOINT, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload)
                });
                showStatus("Saved successfully.");
            } catch (err) {
                showStatus("Error saving data (check internet).");
            }
        }

        // --- 2. NAVIGATION ---
        function showPage(pageId) {
            pages.forEach(p => p.classList.remove('active'));
            navButtons.forEach(b => b.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            // Highlight nav button
            const btnId = 'nav-' + pageId.replace('page-', '');
            const btn = document.getElementById(btnId);
            if(btn) btn.classList.add('active');
            
            renderAllPages();
        }

        navButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const targetId = e.target.id.replace('nav-', 'page-');
                showPage(targetId);
                if(targetId === 'page-new-ticket') {
                    document.getElementById('ticket-date').value = new Date().toLocaleDateString();
                }
            });
        });

        // --- 3. RENDERING ---
        function renderAllPages() {
            // Tickets
            const list = document.getElementById('active-tickets-list');
            list.innerHTML = '';
            const active = allTickets.filter(t => t.status === 'active');
            
            if(active.length === 0) list.innerHTML = '<p style="text-align:center">No active tickets.</p>';
            
            active.forEach(t => {
                const div = document.createElement('div');
                div.className = 'ticket-card';
                div.innerHTML = `
                    <p><strong>Name:</strong> ${t.name}</p>
                    <p><strong>Issue:</strong> ${t.category} (${t.type})</p>
                    <p><strong>Date:</strong> ${new Date(t.date).toLocaleDateString()}</p>
                    <div class="actions">
                        <button class="btn-view" data-id="${t.id}">View Details</button>
                        <button class="btn-close-ticket" data-id="${t.id}">Close Ticket</button>
                    </div>`;
                list.appendChild(div);
            });

            // Loaners
            const tbody = document.getElementById('loaner-table-body');
            tbody.innerHTML = '';
            const search = document.getElementById('loaner-search').value.toLowerCase();
            
            allLoaners.forEach(l => {
                if(String(l.barcode).toLowerCase().includes(search) || l.name.toLowerCase().includes(search)) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${l.name}</td><td>${l.barcode}</td><td>${new Date(l.dateOut).toLocaleDateString()}</td>
                    <td><button class="btn-check-in" data-barcode="${l.barcode}">Check In</button></td>`;
                    tbody.appendChild(tr);
                }
            });

            // Stats
            document.getElementById('stat-active-tickets').textContent = active.length;
            document.getElementById('stat-loaners-out').textContent = allLoaners.length;

            // Report Table
            const rBody = document.getElementById('report-table-body');
            rBody.innerHTML = '';
            const report = {};
            allTickets.forEach(t => {
                const n = t.name.toLowerCase().trim();
                if(!report[n]) report[n] = { name: t.name, count: 0, lastType: t.type, lastIssue: t.category };
                report[n].count++;
            });
            Object.values(report).forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${r.name}</td><td>${r.lastType}</td><td>${r.lastIssue}</td><td>${r.count}</td>`;
                rBody.appendChild(tr);
            });
        }

        // --- 4. FORM HANDLERS ---
        
        // Auto-Email Generator
        ticketNameEl.addEventListener('input', () => {
            const parts = ticketNameEl.value.trim().toLowerCase().split(' ');
            if (parts.length > 1) ticketEmailEl.value = `${parts[0]}.${parts[parts.length-1]}@techstudents.us`;
            validateForm();
        });

        // Ticket Submit
        ticketForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-ticket-btn');
            if(btn.disabled) return;
            
            const newTicket = {
                action: 'addTicket',
                id: Date.now(),
                date: new Date().toISOString(),
                barcode: document.getElementById('ticket-barcode').value,
                name: ticketNameEl.value,
                email: ticketEmailEl.value,
                type: document.getElementById('ticket-type').value,
                category: document.getElementById('ticket-category').value,
                description: document.getElementById('ticket-description').value,
                status: 'active'
            };

            // UI Update Immediate (Optimistic)
            allTickets.unshift(newTicket);
            renderAllPages();
            
            // FIXED: Proper Form Clearing
            ticketForm.reset();
            document.getElementById('ticket-date').value = new Date().toLocaleDateString();
            
            showPage('page-view-tickets');
            
            // Server Sync
            sendData(newTicket);
        });

        // Loaner Submit
        loanerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const barcode = document.getElementById('loaner-barcode').value;
            
            // FIXED: String comparison for validation
            if(allLoaners.some(l => String(l.barcode) === String(barcode))) {
                alert("Loaner already checked out!");
                return;
            }

            const newLoaner = {
                action: 'addLoaner',
                name: document.getElementById('loaner-name').value,
                barcode: barcode,
                dateOut: new Date().toISOString()
            };

            allLoaners.push(newLoaner);
            renderAllPages();
            loanerForm.reset();
            sendData(newLoaner);
        });

        // Actions (Delegation)
        document.addEventListener('click', (e) => {
            // Close Ticket
            if(e.target.classList.contains('btn-close-ticket')) {
                if(!confirm("Close ticket?")) return;
                const id = e.target.dataset.id;
                const t = allTickets.find(x => x.id == id);
                if(t) {
                    t.status = 'closed';
                    renderAllPages();
                    sendData({ action: 'closeTicket', id: id });
                }
            }
            // Check In Loaner
            if(e.target.classList.contains('btn-check-in')) {
                const bc = e.target.dataset.barcode;
                if(!confirm(`Check in ${bc}?`)) return;
                
                // FIXED: String comparison bug (Fixes Check In button)
                allLoaners = allLoaners.filter(l => String(l.barcode) !== String(bc));
                
                renderAllPages();
                sendData({ action: 'returnLoaner', barcode: bc });
            }
            // View Details
            if(e.target.classList.contains('btn-view')) {
                const t = allTickets.find(x => x.id == e.target.dataset.id);
                if(t) showModal(t);
            }
        });

        // Search Handlers
        document.getElementById('loaner-search').addEventListener('input', renderAllPages);

        // Validation
        const inputs = ticketForm.querySelectorAll('input, select, textarea');
        function validateForm() {
            let valid = true;
            inputs.forEach(i => { if(i.hasAttribute('required') && !i.value) valid = false; });
            document.getElementById('submit-ticket-btn').disabled = !valid;
        }
        inputs.forEach(i => i.addEventListener('input', validateForm));

        // Modal
        const modal = document.getElementById('details-modal');
        document.querySelector('.modal-close').onclick = () => modal.style.display = 'none';
        window.onclick = (e) => { if(e.target == modal) modal.style.display = 'none'; }
        
        function showModal(t) {
            const body = document.getElementById('modal-body');
            body.innerHTML = `
                <p><strong>Desc:</strong> ${t.description}</p>
                <hr>
                <p><strong>Email:</strong> ${t.email}</p>
                <p><strong>Barcode:</strong> ${t.barcode}</p>
            `;
            document.getElementById('modal-title').textContent = `Ticket #${t.id}`;
            modal.style.display = 'block';
        }

        // Init
        document.getElementById('ticket-date').value = new Date().toLocaleDateString();
        loadData();
    });
    </script>
</body>
</html>

